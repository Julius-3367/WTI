import React from 'react';
import { Grid, Alert, Button, Box, Card, CardContent, Typography, LinearProgress } from '@mui/material';
import {
  School as CourseIcon,
  CheckCircle as CompletedIcon,
  EmojiEvents as TrophyIcon,
  CalendarToday as AttendanceIcon,
  Assignment as AssignmentIcon,
  Work as WorkIcon,
} from '@mui/icons-material';
import { useNavigate } from 'react-router-dom';
import useDashboard from '../../hooks/useDashboard';
import candidateService from '../../api/candidate';
import {
  DashboardLayout,
  StatCard,
  ActivityTimeline,
  UpcomingEvents,
  CourseProgress,
} from '../../components/dashboard';

const CandidateDashboard = () => {
  const navigate = useNavigate();

  const { data, loading, error, lastUpdated, refresh } = useDashboard(
    async () => {
      const [dashData, coursesData] = await Promise.all([
        candidateService.getDashboardData(),
        candidateService.getMyCourses(),
      ]);
      return { ...dashData, courses: coursesData || [] };
    },
    { refreshInterval: 30000, autoRefresh: true }
  );

  const profile = data?.profile || {};
  const stats = data?.stats || {};
  const currentCourses = data?.currentCourses || [];
  const courses = data?.courses || [];
  const upcomingEvents = data?.upcomingEvents || [];
  const profileCompletion = profile.completionRate || 0;

  const activeCourses = courses
    .filter(c => c.enrollmentStatus === 'ENROLLED')
    .map(course => ({
      id: course.courseId || course.id,
      title: course.course?.title || course.title || 'Untitled Course',
      progress: course.progress || 0,
      instructor: 'TBA',
      status: course.progress >= 80 ? 'Almost Complete' : 'In Progress',
      nextSession: course.course?.startDate || new Date().toISOString(),
    }));

  const formattedEvents = upcomingEvents.map(event => ({
    id: event.id,
    title: event.title,
    date: event.date,
    time: event.time,
    location: event.location || 'Online',
    type: event.type,
  }));

  const recentActivity = currentCourses.slice(0, 5).map(course => ({
    id: `course-${course.id}`,
    type: 'enrollment',
    title: `Enrolled in ${course.title}`,
    description: `Progress: ${course.progress}%`,
    timestamp: new Date(course.nextSession).toISOString(),
    status: course.status,
  }));

  return (
    <DashboardLayout
      title="Candidate Dashboard"
      subtitle="Track your training progress and career opportunities"
      loading={loading}
      error={error}
      lastUpdated={lastUpdated}
      onRefresh={refresh}
      alerts={
        profileCompletion < 100 && (
          <Alert severity="warning" action={<Button color="inherit" size="small" onClick={() => navigate('/candidate/profile')}>Complete Now</Button>}>
            Your profile is {profileCompletion}% complete. Complete your profile to unlock more opportunities!
          </Alert>
        )
      }
    >
      <Grid container spacing={3}>
        <Grid item xs={12} sm={6} md={3}>
          <StatCard title="Active Courses" value={stats.activeCourses || 0} icon={CourseIcon} color="primary" loading={loading} onClick={() => navigate('/candidate/courses')} subtitle="Currently enrolled" />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatCard title="Completed" value={stats.completedCourses || 0} icon={CompletedIcon} color="success" loading={loading} onClick={() => navigate('/candidate/courses')} subtitle="Finished courses" />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatCard title="Certificates" value={stats.certificates || 0} icon={TrophyIcon} color="warning" loading={loading} onClick={() => navigate('/candidate/certificates')} subtitle="Earned credentials" />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatCard title="Attendance" value={`${stats.attendanceRate || 0}%`} icon={AttendanceIcon} color="info" loading={loading} onClick={() => navigate('/candidate/attendance')} subtitle="Overall rate" />
        </Grid>

        {profileCompletion < 100 && (
          <Grid item xs={12}>
            <Card>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 2 }}>
                  <Typography variant="h6" fontWeight={600}>Profile Completion</Typography>
                  <Typography variant="h6" color="primary" fontWeight={600}>{profileCompletion}%</Typography>
                </Box>
                <LinearProgress variant="determinate" value={profileCompletion} sx={{ height: 10, borderRadius: 1, mb: 2 }} />
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>Complete your profile to improve job matching</Typography>
                <Button variant="contained" size="small" onClick={() => navigate('/candidate/profile')}>Complete Profile</Button>
              </CardContent>
            </Card>
          </Grid>
        )}

        <Grid item xs={12} lg={8}>
          <CourseProgress courses={activeCourses} loading={loading} title="My Active Courses" onCourseClick={(course) => navigate(`/candidate/courses/${course.id}`)} />
        </Grid>

        <Grid item xs={12} lg={4}>
          <UpcomingEvents events={formattedEvents} loading={loading} title="Upcoming Events" onEventClick={(event) => { if (event.type === 'assessment') navigate('/candidate/assessments'); }} />
        </Grid>

        <Grid item xs={12}>
          <Card>
            <CardContent>
              <Typography variant="h6" fontWeight={600} gutterBottom>Quick Actions</Typography>
              <Grid container spacing={2} sx={{ mt: 1 }}>
                <Grid item xs={6} sm={3}><Button fullWidth variant="outlined" startIcon={<CourseIcon />} onClick={() => navigate('/candidate/courses')}>Courses</Button></Grid>
                <Grid item xs={6} sm={3}><Button fullWidth variant="outlined" startIcon={<AssignmentIcon />} onClick={() => navigate('/candidate/assessments')}>Assessments</Button></Grid>
                <Grid item xs={6} sm={3}><Button fullWidth variant="outlined" startIcon={<TrophyIcon />} onClick={() => navigate('/candidate/certificates')}>Certificates</Button></Grid>
                <Grid item xs={6} sm={3}><Button fullWidth variant="outlined" startIcon={<WorkIcon />} onClick={() => navigate('/candidate/jobs')}>Jobs</Button></Grid>
              </Grid>
            </CardContent>
          </Card>
        </Grid>

        {recentActivity.length > 0 && (
          <Grid item xs={12}>
            <ActivityTimeline activities={recentActivity} loading={loading} title="Recent Activity" />
          </Grid>
        )}
      </Grid>
    </DashboardLayout>
  );
};

export default CandidateDashboard;
